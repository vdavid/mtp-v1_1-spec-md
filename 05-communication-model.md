## 4 Communication Model

MTP follows a simple operation-data-response model for all communications. While the
resulting functionality may be complex, it is entirely layered upon the core fundamentals
described in this chapter.

### 4.1 Initiator/Responder Roles

MTP exchanges may only occur between two products at a time, and in each
communication, one product acts as the Initiator and the other as the Responder. The
Initiator is the product that initiates actions with the responder by sending operations to
the Responder. The Responder may not initiate any actions, and may only send responses
to operations sent by the Initiator or send events.

In this specification, the USB Host is the Initiator, and the USB Device is the Responder.

The Initiator must be able to enumerate and understand the contents of the Responder,
handle and respond to events generated by the Responder, and control the flow of
operations in the protocol.

Products expected to take on the Responder role include simple content-production
devices, such as digital cameras or portable audio recorders, and simple content-display
devices, such as personal information managers and portable audio players. Products
expected to take on the Initiator role include personal computers, and products such as
direct-print printers, designed primarily to connect with simple content-production
devices.

### 4.2 Unidirectional Data Flow

The data flow in MTP is always unidirectional. When initiating an operation, data flows
only from the Initiator to the Responder. When responding to the requested operation, the
data flows only from the Responder to the Initiator. During the binary data-exchange
phase, data may flow from the Responder to the Initiator or from the Initiator to the
Responder, but never both. Bi-directional, binary data exchange must be performed by
multiple operations.

### 4.3 MTP Transactions

Any Initiator-initiated action in MTP is performed in a transaction, a standard sequence
of phases that provides the mechanism for action invocation with input parameters,
responses with parameters, and binary data exchange. Note that the name “Transactions”
is used for compatibility with the PTP specification, and must not be confused with
“Transaction” as used in the USB 2.0 specification and related documents. If there is
possibility of confusion, the term “MTP Transaction” will be used to refer to the
transactions defined in this document, and “USB Transaction” will be used to refer to the
low-level transactions of the USB spec.

#### 4.3.1 Transaction Synchronicity

All transactions in an MTP exchange are synchronous. That is, a new operation cannot be
initiated until the previous operation has fully completed. If a device supports multiple
sessions, it must manage each session to simulate synchronicity for each connected
device.

Asynchronous operations must be simulated by separating the operation into an initiation,
which begins the operation, and progress monitoring, through Responder-generated
events sent while the operation is executed in the background on the device. If an
operation is attempted while an asynchronous operation is processing which cannot be
fulfilled due to the ongoing asynchronous operation, the responder shall respond with a
Device_Busy failure code.

The only exception to this atomic process involves events. Events may be sent at any
time, and are defined in such a manner as to allow them to be sent without interrupting an
ongoing transaction. For more information about events, refer to section 4.8 Events.

#### 4.3.2 Transaction Phases

A transaction in MTP consists of up to three phases: the Operation Request Phase, the
Data Phase, and the Response Phase. The Operation Request Phase and Response Phase
are identified together by sharing a TransactionID. The Data Phase is optional, and is
placed between the two other phases of the transaction when used.

#### 4.3.3 Transaction IDs

Transactions are identified using an unsigned 32-bit integer called a TransactionID.
TransactionIDs are chosen by the Initiator, and should be chosen starting at 0x00000001
for the first operation initiated in a session and incremented by 1 for each successive
transaction.

The TransactionID of 0xFFFFFFFF is invalid, and shall not be used by an Initiator.
Instead, if a sequence of transactions results in the TransactionID incrementing to
0xFFFFFFFF, it shall instead wrap around to 0x00000001.

### 4.4 Sessions

MTP contains the concept of a session, which is a communications state in which a
connection has persisted and a state has been maintained. Sessions serve two functional
purposes in MTP: they provide a single context in which to reference objects, and they
guarantee that the Responder device state has not changed without alerting the Initiator to
that change.

An open session is not required for all operations, only for operations that require state
context to execute or respond accurately. Any operation involving an Object Handles or
StorageID is required to be session-aware. However, operations such as GetDeviceInfo do not involve any
session-dependent information, and can be executed with or without an active session.

#### 4.4.1 Opening and Closing Sessions

The Initiator opens a Session by sending the OpenSession operation.

A session may be ended by the Initiator by sending a CloseSession operation, is ended
automatically when there is an interruption in communications between Initiator and
Responder, or may be ended at any time by the Responder. If the Responder chooses to
end a session, it shall indicate this by responding to the next session-aware operation with
a Session_Not_Open response code.

#### 4.4.2 Choosing Session IDs

A product may maintain multiple MTP sessions concurrently, and is not required to fill
the same role in every session. It is thus required that the initiator identify the session in
which it is acting when it sends any session-aware operation. Sessions are identified by a
SessionID, a 32-bit unsigned integer, which is chosen by the Initiator and communicated
in an OpenSession operation.

If an Initiator attempts to open a session on a device that already has an open session and
that does not support multiple sessions, the Responder shall respond with a
Session_Already_Open response, and pass the SessionID of the open session as the first
parameter.

If an Initiator attempts to choose a SessionID that is already in use on a device that
supports multiple concurrent sessions, the Responder shall respond with
Session_Already_Open, and pass the chosen SessionID as the first parameter in the
response.

If an Initiator attempts to open a session on a device that supports a finite number of
multiple concurrent sessions, but that has already opened the maximum number of
supported sessions, the Responder shall fail with a response code of Device_Busy.

The values 0x00000000 and 0xFFFFFFFF have special meanings for SessionIDs. These
meanings are described in relevant operations.

### 4.5 Operations

The Operation Request Phase initiates a transaction, and consists of the transmission of
an Operation Request dataset from the Initiator to the Responder. The dataset identifies
the operation that is being invoked by the initiator using an Operation Code, the context
in which it is to be executed (session and transaction), and a limited set of parameters
modifying the request.

#### 4.5.1 Operation Datacodes

Operations are defined by a 16-bit datacode, which is included in the Operation Request
Dataset as defined in section 4.5.2.

The most significant 5 bits have special meaning, as described in the following table.

| Bit 15 | Bit 14 | Bit 13 | Bit 12 | Bit 11 | Bits 10-0 | Values         | Datacode type                       |
|--------|--------|--------|--------|--------|-----------|----------------|-------------------------------------|
| 0      | 0      | 0      | 1      | Any    | Any       | 0x1000..0x1FFF | PTP Operation Code                  |
| 1      | 0      | 0      | 1      | 0      | Any       | 0x9000..0x97FF | MTP Vendor Extension Operation Code |
| 1      | 0      | 0      | 1      | 1      | Any       | 0x9800..0x9FFF | MTP Operation Code                  |

All other values are reserved.

#### 4.5.2 Operation Dataset

The layout of the Operation Dataset is provided for reference. Depending on the
capabilities of the transport layer, some of these fields may be omitted at the interface
between Initiator and Responder, and generated as needed for internal use. For example,
the USB SIC transport omits the SessionID, because SIC only supports a single session.
The USB SIC transport includes a length prefix, which allows unused parameters to be
omitted at the USB layer.

| Field          | Size (bytes) | Datatype |
|----------------|--------------|----------|
| Operation Code | 2            | UINT16   |
| SessionID      | 4            | UINT32   |
| TransactionID  | 4            | UINT32   |
| Parameter 1    | 4            | Any      |
| Parameter 2    | 4            | Any      |
| Parameter 3    | 4            | Any      |
| Parameter 4    | 4            | Any      |
| Parameter 5    | 4            | Any      |

#### 4.5.3 Operation Parameters

Information required to act on an initiated operation may be passed as parameters in the
Operation Request. This allows up to 5 parameters to be sent, each consisting of 32-bits
or less.

Additional information may also be passed in a pre-defined dataset in the Data Phase of
the transaction. Additional information about the Data Phase is available in section 4.6
Data Phases.

##### 4.5.3.1 Operation Code

This identifies the operation being initiated by the device. For a list of these operations
and their usages, refer to the appropriate appendix.

##### 4.5.3.2 SessionID

This identifies the session in which this operation exists. For more information about
sessions, refer to section 4.4 Sessions. If an operation occurs outside an active session,
this field shall be set to 0x00000000.

##### 4.5.3.3 TransactionID

This provides an identifier for the transaction initiated by this operation request. For more
information, refer to section 4.3 MTP Transactions. This field shall contain 0x00000000
for operations that do not occur within a session.

##### 4.5.3.4 Parameter n

These fields allow parameters to be passed along with an operation request. The meaning
of the contents of these fields is context-specific, and depends on the Operation Code in
the first field.

If a parameter is unused or marked as “None”, the parameter value is undefined and shall
be silently ignored. If data exists in a parameter marked as “None”, a Responder shall
return the response code Parameter_Not_Supported.

### 4.6 Data Phases

Following the Operation Request Phase is an optional Data Phase. The presence of this
phase is determined by the Operation Code sent in the Operation Request Phase. If the
Operation Request Phase results in an error state, the device shall still enter a Data Phase
if the Operation Code in the Operation Request Phase indicates that one is required. If
the Data Phase of an operation is I->R, and the responder enters an error state during or
before transfer, the Responder shall complete the data phase as defined (possibly
throwing away data) in order to indicate an appropriate error condition in the Response
phase.

The Data Phase is used to pass any data that cannot be transferred using the parameters of
the operation-request dataset. For some operation requests, this data will consist of
datasets defined by this specification. For other operation requests, the data will be
binary data exchanged for the purpose of storage on the receiving device. If the data
being sent in the data phase is not a dataset defined by this specification, it must be
considered opaque.

The actual transmission of data may involve wrapping the data to be sent in a container
format, or breaking it apart into packets to be reassembled upon receipt.

Note that when SIC class is being used for a data transport, a container is used.

### 4.7 Responses

Following every operation, the responder returns a response dataset as defined in section 4.7.2 Response Dataset. This
response dataset contains up to five 32-bit parameters and a ResponseCode indicating the result of the operation.

ResponseCodes other than OK indicate that the operation did not complete.

#### 4.7.1 Response Datacodes

Responses are identified by their ResponseCode, which is included in the response
dataset as defined in section 4.7.2 Response Dataset. All ResponseCodes are 16-bit
integers, with the most significant five bits having special meaning, as described in the
following table.

| Bit 15 | Bit 14 | Bit 13 | Bit 12 | Bit 11 | Bits 10-0 | Values         | Datacode type                  |
|--------|--------|--------|--------|--------|-----------|----------------|--------------------------------|
| 0      | 0      | 1      | 0      | Any    | Any       | 0x2000..0x2FFF | PTP ResponseCodes              |
| 1      | 0      | 1      | 0      | 0      | Any       | 0xA000..0xA7FF | Vendor Extension ResponseCodes |
| 1      | 0      | 1      | 0      | 1      | Any       | 0xA800..0xAFFF | MTP ResponseCodes              |

#### 4.7.2 Response Dataset

The layout of the Response Dataset is provided for reference. Depending on the
capabilities of the transport layer, some of these fields may be omitted at the interface
between Initiator and Responder, and generated as needed for internal use. For example,
the USB SIC transport omits the SessionID, because SIC only supports a single session.

The USB SIC transport includes a length prefix, which allows unused parameters to be
omitted at the USB layer.

| Field         | Size (bytes) | Format |
|---------------|--------------|--------|
| ResponseCode  | 2            | UINT16 |
| SessionID     | 4            | UINT32 |
| TransactionID | 4            | UINT32 |
| Parameter 1   | 4            | Any    |
| Parameter 2   | 4            | Any    |
| Parameter 3   | 4            | Any    |
| Parameter 4   | 4            | Any    |
| Parameter 5   | 4            | Any    |

#### 4.7.3 Response Parameters

Responses may include up to five 32-bit parameters, and all devices must include and
accommodate all parameters. When a parameter is not used for a given response, the
corresponding field shall be set to 0x00000000.

##### 4.7.3.1 ResponseCode

This datacode identifies the result of the requested operation. Further definition of
allowed responses can be found in Appendix F – Responses.

##### 4.7.3.2 SessionID

This field identifies the session in which this operation exists. For more information, refer
to section 4.4 Sessions. If an operation occurs outside of an active session, this field shall
be set to 0x00000000. The value of this field shall be identical to the value in the
Operation Request dataset that was received by the Responder in this transaction.

##### 4.7.3.3 TransactionID

This field provides an identifier for the transaction initiated by this operation request. For
more information, refer to section 4.3 MTP Transactions. This field shall contain
0x00000000 for operations that do not occur within a session.

##### 4.7.3.4 Parameter n

These fields allow parameters to be passed along with a response code. The meaning of
the contents of these fields is context-specific, and depends on the Response Code in the
first field.

If a parameter is unused or marked as “None”, the parameter value is undefined and
should be silently ignored.

### 4.8 Events

This section describes events, their datasets and their usages. Event support is a
mandatory part of MTP.

Although events may be sent by either the Initiator or the Responder, they are primarily
sent by the Responder as a way of proactively transmitting information or alerts. Unlike
operations, events are not acknowledged, and need not be acted upon.

Events are not intended to convey information beyond the notification of an event. If an
event is indicating the change of state on the device, the event dataset will contain only
enough information to enable the device receiving the event to determine the nature of
the state change with minimal effort through normal methods.

Events may be implemented in multiple steps, by first indicating the presence of an event,
and then requiring a round-trip to retrieve it. When that is the case, the event code shall
be sent in the initial event-indication dataset, and the remaining data shall be retrievable
upon request.

Events are only sent to Initiators or Responders that are connected with an open session.
For more information on sessions, refer to section 4.4 Sessions.

#### 4.8.1 Event Datacodes

All events are identified by their Event Code, which is a 16-bit datacode. The most
significant 5 bits have special meaning, as defined in the following table.

| Bit 15 | Bit 14 | Bit 13 | Bit 12 | Bit 11 | Bits 10-0 | Datacode type               |
|--------|--------|--------|--------|--------|-----------|-----------------------------|
| 0      | 1      | 0      | 0      | Any    | Any       | PTP Event Codes             |
| 1      | 1      | 0      | 0      | 0      | Any       | Vendor Extension Event Code |
| 1      | 1      | 0      | 0      | 1      | Any       | MTP Event Codes             |

#### 4.8.2 Event Dataset

Events are communicated in the form of an event dataset, which consists of the minimum
required information to act on the event. In general, the data contained in this dataset is
minimized, and if the event code alone is insufficient, the device receiving the event must
probe the sending device for more information after receiving the event.

| Field         | Size (bytes) | Format |
|---------------|--------------|--------|
| Event Code    | 2            | UINT16 |
| SessionID     | 4            | UINT32 |
| TransactionID | 4            | UINT32 |
| Parameter 1   | 4            | Any    |
| Parameter 2   | 4            | Any    |
| Parameter 3   | 4            | Any    |

#### 4.8.3 Event Parameters

##### 4.8.3.1 Event Code

This field identifies the event being indicated by this dataset. A listing of event codes and
their meanings can be found in the appropriate Appendix of this specification.

##### 4.8.3.2 SessionID

This field identifies the SessionID for which the event is relevant. If this event is relevant
to all current sessions, it shall contain 0xFFFFFFFF. If a device receives an event for
which the SessionID does not match a session that the receiving device currently has
open, and that does not contain 0xFFFFFFFF, then the event shall be ignored.

For more information on sessions, refer to section 4.4 Sessions.

##### 4.8.3.3 TransactionID

If the event corresponds to a previously or currently occurring transaction, this field shall
contain that transaction's TransactionID. For more information, refer to section 4.3 MTP
Transactions.

##### 4.8.3.4 Parameter n

This field holds a parameter that can be passed with this event. Events may have at most
three parameters, and all must occupy 32 bits. The interpretation of event parameters
depends upon the event with which they are being sent.

If a parameter is unused or marked as “None”, the parameter value is undefined and
should be silently ignored.

#### 4.8.4 Asynchronous Event Support

As explained in section 2.3 Asynchronous Events, events are required to be
communicated asynchronously with data transmission or operation transactions.

##### 4.8.4.1 Interleaving Events

If a dedicated event channel exists, the protocol for that channel must define a process by
which events may be interleaved within a data stream during a transaction. It may be
assumed that the Operation Request Phase and Response Phase (For more information,
see sections 4.5 Operations and 4.7 Responses.) are atomic, but the Data Phase must
allow for events to be communicated in either direction without interrupting data transfer.
For more information about the data phase, refer to section 4.3.2 Transaction Phases and
section 4.6 Data Phases.

Care should be taken to ensure sufficient responsiveness (in general, responsiveness
should be prioritized above data-transfer speed).

